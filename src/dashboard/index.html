<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Copy Trading Bot - Dashboard</title>
  <style>
    :root {
      --bg: #0d1117;
      --surface: #161b22;
      --border: #30363d;
      --text: #e6edf3;
      --muted: #8b949e;
      --green: #3fb950;
      --red: #f85149;
      --blue: #58a6ff;
      --yellow: #d29922;
      --accent: #1f6feb;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
    }

    header {
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      padding: 16px 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    header h1 {
      font-size: 18px;
      font-weight: 600;
    }

    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 13px;
      padding: 4px 12px;
      border-radius: 20px;
      background: rgba(63,185,80,0.15);
      color: var(--green);
    }

    .status-badge.disconnected {
      background: rgba(248,81,73,0.15);
      color: var(--red);
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: currentColor;
    }

    .container {
      max-width: 1280px;
      margin: 0 auto;
      padding: 24px;
    }

    /* Metric cards */
    .cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }

    .card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 16px;
    }

    .card-label {
      font-size: 12px;
      text-transform: uppercase;
      color: var(--muted);
      letter-spacing: 0.5px;
      margin-bottom: 8px;
    }

    .card-value {
      font-size: 24px;
      font-weight: 600;
      font-variant-numeric: tabular-nums;
    }

    .card-sub {
      font-size: 12px;
      color: var(--muted);
      margin-top: 4px;
    }

    .positive { color: var(--green); }
    .negative { color: var(--red); }

    /* Sections */
    .section {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 8px;
      margin-bottom: 24px;
      overflow: hidden;
    }

    .section-header {
      padding: 14px 16px;
      font-size: 14px;
      font-weight: 600;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    /* Tables */
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }

    th {
      text-align: left;
      padding: 10px 12px;
      color: var(--muted);
      font-weight: 500;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      border-bottom: 1px solid var(--border);
      background: var(--surface);
      position: sticky;
      top: 0;
    }

    td {
      padding: 10px 12px;
      border-bottom: 1px solid var(--border);
      font-variant-numeric: tabular-nums;
    }

    tr:hover td { background: rgba(255,255,255,0.02); }

    .side-buy { color: var(--green); font-weight: 600; }
    .side-sell { color: var(--red); font-weight: 600; }

    .token-id {
      max-width: 140px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      font-family: monospace;
      font-size: 12px;
    }

    .empty-state {
      padding: 40px 16px;
      text-align: center;
      color: var(--muted);
    }

    /* Tab bar */
    .tabs {
      display: flex;
      gap: 0;
      border-bottom: 1px solid var(--border);
    }

    .tab {
      padding: 10px 16px;
      font-size: 13px;
      color: var(--muted);
      cursor: pointer;
      border-bottom: 2px solid transparent;
      transition: color 0.15s, border-color 0.15s;
    }

    .tab:hover { color: var(--text); }
    .tab.active { color: var(--text); border-bottom-color: var(--accent); }

    .tab-content { display: none; }
    .tab-content.active { display: block; }

    .table-scroll {
      max-height: 400px;
      overflow-y: auto;
    }

    /* Performance bar */
    .perf-row {
      display: flex;
      justify-content: space-between;
      padding: 8px 16px;
      border-bottom: 1px solid var(--border);
      font-size: 13px;
    }

    .perf-row:last-child { border-bottom: none; }
    .perf-label { color: var(--muted); }

    /* Responsive */
    @media (max-width: 768px) {
      .cards { grid-template-columns: repeat(2, 1fr); }
      .container { padding: 12px; }
    }
  </style>
</head>
<body>
  <header>
    <h1>Polymarket Copy Trading Bot</h1>
    <div id="connectionStatus" class="status-badge disconnected">
      <span class="status-dot"></span>
      <span id="statusText">Connecting...</span>
    </div>
  </header>

  <div class="container">
    <!-- Metric Cards -->
    <div class="cards">
      <div class="card">
        <div class="card-label">Mode</div>
        <div class="card-value" id="modeValue">--</div>
        <div class="card-sub" id="pollingMethod">--</div>
      </div>
      <div class="card">
        <div class="card-label">Balance</div>
        <div class="card-value" id="balanceValue">--</div>
        <div class="card-sub" id="balanceSub"></div>
      </div>
      <div class="card">
        <div class="card-label">Total P&L</div>
        <div class="card-value" id="pnlValue">--</div>
        <div class="card-sub" id="dailyPnl"></div>
      </div>
      <div class="card">
        <div class="card-label">Trades</div>
        <div class="card-value" id="tradeCountValue">--</div>
        <div class="card-sub" id="tradeCountSub"></div>
      </div>
      <div class="card">
        <div class="card-label">Polls</div>
        <div class="card-value" id="pollCountValue">--</div>
        <div class="card-sub" id="pollSub"></div>
      </div>
      <div class="card">
        <div class="card-label">Avg Latency</div>
        <div class="card-value" id="latencyValue">--</div>
        <div class="card-sub" id="latencySub"></div>
      </div>
    </div>

    <!-- Positions -->
    <div class="section">
      <div class="section-header">
        Open Positions
        <span id="positionCount" style="color: var(--muted); font-weight: 400; font-size: 13px;">0</span>
      </div>
      <div id="positionsBody">
        <div class="empty-state">No open positions</div>
      </div>
    </div>

    <!-- Tabs: Trades / Performance / Sessions -->
    <div class="section">
      <div class="tabs">
        <div class="tab active" data-tab="trades">Recent Trades</div>
        <div class="tab" data-tab="performance">Performance</div>
        <div class="tab" data-tab="sessions">Sessions</div>
      </div>

      <div id="tab-trades" class="tab-content active">
        <div class="table-scroll">
          <table>
            <thead>
              <tr>
                <th>Time</th>
                <th>Side</th>
                <th>Size</th>
                <th>Price</th>
                <th>Cost</th>
                <th>P&L</th>
                <th>Status</th>
                <th>Latency</th>
                <th>Token</th>
              </tr>
            </thead>
            <tbody id="tradesTable"></tbody>
          </table>
        </div>
        <div id="tradesEmpty" class="empty-state">No trades yet</div>
      </div>

      <div id="tab-performance" class="tab-content">
        <div id="perfBody">
          <div class="empty-state">No performance data</div>
        </div>
      </div>

      <div id="tab-sessions" class="tab-content">
        <div class="table-scroll">
          <table>
            <thead>
              <tr>
                <th>Started</th>
                <th>Ended</th>
                <th>Mode</th>
                <th>Polls</th>
                <th>Detected</th>
                <th>Executed</th>
                <th>P&L</th>
                <th>Balance</th>
              </tr>
            </thead>
            <tbody id="sessionsTable"></tbody>
          </table>
        </div>
        <div id="sessionsEmpty" class="empty-state">No sessions yet</div>
      </div>
    </div>
  </div>

  <script>
    // ============================================
    // STATE
    // ============================================
    let ws = null;
    let reconnectTimer = null;
    const WS_URL = `ws://${location.host}`;

    // ============================================
    // WEBSOCKET
    // ============================================
    function connect() {
      ws = new WebSocket(WS_URL);

      ws.onopen = () => {
        setConnectionStatus(true);
        // Fetch initial data via REST
        fetchTrades();
        fetchPerformance();
        fetchSessions();
      };

      ws.onmessage = (event) => {
        const msg = JSON.parse(event.data);
        if (msg.type === "stats") updateStats(msg.data);
        if (msg.type === "positions") updatePositions(msg.data);
        if (msg.type === "trade") {
          // Refresh trades list on new trade
          fetchTrades();
          fetchPerformance();
        }
      };

      ws.onclose = () => {
        setConnectionStatus(false);
        reconnectTimer = setTimeout(connect, 3000);
      };

      ws.onerror = () => ws.close();
    }

    function setConnectionStatus(connected) {
      const el = document.getElementById("connectionStatus");
      const text = document.getElementById("statusText");
      if (connected) {
        el.className = "status-badge";
        text.textContent = "Connected";
      } else {
        el.className = "status-badge disconnected";
        text.textContent = "Disconnected";
      }
    }

    // ============================================
    // REST FETCHES
    // ============================================
    async function fetchTrades() {
      try {
        const res = await fetch("/api/trades?limit=50");
        const data = await res.json();
        renderTrades(data.trades);
      } catch { /* ignore */ }
    }

    async function fetchPerformance() {
      try {
        const [perfRes, tokensRes] = await Promise.all([
          fetch("/api/performance"),
          fetch("/api/performance/tokens"),
        ]);
        const perf = await perfRes.json();
        const tokens = await tokensRes.json();
        renderPerformance(perf, tokens.tokens);
      } catch { /* ignore */ }
    }

    async function fetchSessions() {
      try {
        const res = await fetch("/api/sessions?limit=20");
        const data = await res.json();
        renderSessions(data.sessions);
      } catch { /* ignore */ }
    }

    // ============================================
    // RENDER: Stats cards
    // ============================================
    function updateStats(stats) {
      setText("modeValue", stats.mode?.toUpperCase() || "--");
      setText("pollingMethod", stats.pollingMethod || "--");
      setText("balanceValue", "$" + fmt(stats.balance, 2));
      setText("pnlValue", "$" + fmt(stats.totalPnL, 2));
      colorize("pnlValue", stats.totalPnL);
      setText("dailyPnl", "Daily: $" + fmt(stats.dailyPnL, 2));
      setText("tradeCountValue", String(stats.tradeCount));

      const ps = stats.pollerStats || {};
      const detected = ps.tradesDetected ?? ps.changesDetected ?? 0;
      setText("tradeCountSub", detected + " detected");
      setText("pollCountValue", String(ps.pollCount || 0));

      const errs = ps.consecutiveErrors || 0;
      setText("pollSub", errs > 0 ? errs + " errors" : (ps.isRunning ? "Running" : "Stopped"));

      const lat = stats.latencyStats || {};
      if (lat.sampleCount > 0) {
        setText("latencyValue", lat.avgTotalMs + "ms");
        const parts = [
          "Det: " + lat.avgDetectionMs + "ms",
          "Proc: " + (lat.avgProcessingMs || 0) + "ms",
          "Order: " + (lat.avgOrderMs || 0) + "ms",
        ];
        setText("latencySub", parts.join(" | "));
      }
    }

    // ============================================
    // RENDER: Positions
    // ============================================
    function updatePositions(data) {
      const positions = data.positions || [];
      setText("positionCount", String(positions.length));

      if (positions.length === 0) {
        document.getElementById("positionsBody").innerHTML =
          '<div class="empty-state">No open positions</div>';
        return;
      }

      let html = '<table><thead><tr>' +
        '<th>Token</th><th>Qty</th><th>Avg Price</th><th>Cost</th><th>Entry</th><th>Opened</th>' +
        '</tr></thead><tbody>';

      for (const p of positions) {
        html += '<tr>' +
          `<td class="token-id" title="${esc(p.tokenId)}">${esc(p.tokenId)}</td>` +
          `<td>${fmt(p.quantity, 2)}</td>` +
          `<td>$${fmt(p.avgPrice, 4)}</td>` +
          `<td>$${fmt(p.totalCost, 2)}</td>` +
          `<td>${p.entryPrice ? "$" + fmt(p.entryPrice, 4) : "--"}</td>` +
          `<td>${p.openedAt ? timeAgo(p.openedAt) : "--"}</td>` +
          '</tr>';
      }

      html += '</tbody></table>';
      document.getElementById("positionsBody").innerHTML = html;
    }

    // ============================================
    // RENDER: Trades table
    // ============================================
    function renderTrades(trades) {
      const tbody = document.getElementById("tradesTable");
      const empty = document.getElementById("tradesEmpty");

      if (!trades || trades.length === 0) {
        tbody.innerHTML = "";
        empty.style.display = "block";
        return;
      }
      empty.style.display = "none";

      tbody.innerHTML = trades.map(t => {
        const sideClass = t.side === "BUY" ? "side-buy" : "side-sell";
        const pnlHtml = t.pnl != null
          ? `<span class="${t.pnl >= 0 ? 'positive' : 'negative'}">$${fmt(t.pnl, 2)}</span>`
          : "--";
        const latency = t.totalLatencyMs ? t.totalLatencyMs + "ms" : "--";
        return `<tr>
          <td>${shortTime(t.createdAt)}</td>
          <td class="${sideClass}">${t.side}</td>
          <td>${fmt(t.size, 2)}</td>
          <td>$${fmt(t.price, 4)}</td>
          <td>$${fmt(t.cost, 2)}</td>
          <td>${pnlHtml}</td>
          <td>${t.status}</td>
          <td>${latency}</td>
          <td class="token-id" title="${esc(t.tokenId)}">${esc(t.tokenId)}</td>
        </tr>`;
      }).join("");
    }

    // ============================================
    // RENDER: Performance
    // ============================================
    function renderPerformance(perf, tokens) {
      const el = document.getElementById("perfBody");
      if (!perf || perf.totalTrades === 0) {
        el.innerHTML = '<div class="empty-state">No performance data</div>';
        return;
      }

      let html = '';

      // Summary rows
      const rows = [
        ["Total Trades", `${perf.totalTrades} (${perf.buyCount} buys, ${perf.sellCount} sells)`],
        ["Total Volume", "$" + fmt(perf.totalVolume, 2)],
        ["Total P&L", "$" + fmt(perf.totalPnl, 2), perf.totalPnl],
        ["Win Rate", perf.winCount + perf.lossCount > 0
          ? `${(perf.winRate * 100).toFixed(1)}% (${perf.winCount}W / ${perf.lossCount}L)`
          : "N/A"],
        ["Best Trade", perf.bestTradePnl ? "$" + fmt(perf.bestTradePnl, 2) : "N/A", perf.bestTradePnl],
        ["Worst Trade", perf.worstTradePnl ? "$" + fmt(perf.worstTradePnl, 2) : "N/A", perf.worstTradePnl],
        ["Avg Trade Size", fmt(perf.avgTradeSize, 2) + " shares"],
        ["Avg Latency", perf.avgLatencyMs > 0 ? perf.avgLatencyMs.toFixed(0) + "ms" : "N/A"],
      ];

      html += rows.map(([label, value, colorVal]) => {
        let valClass = "";
        if (colorVal !== undefined) valClass = colorVal >= 0 ? "positive" : "negative";
        return `<div class="perf-row"><span class="perf-label">${label}</span><span class="${valClass}">${value}</span></div>`;
      }).join("");

      // Token P&L
      if (tokens && tokens.length > 0) {
        html += '<div style="padding: 14px 16px; font-weight: 600; font-size: 13px; border-top: 1px solid var(--border); border-bottom: 1px solid var(--border);">P&L by Token</div>';
        html += tokens.map(t => {
          const title = t.marketTitle || t.tokenId.slice(0, 20) + "...";
          const pnlClass = t.pnl >= 0 ? "positive" : "negative";
          return `<div class="perf-row">
            <span class="perf-label" title="${esc(t.tokenId)}">${esc(title)} (${t.tradeCount} trades)</span>
            <span class="${pnlClass}">$${fmt(t.pnl, 2)}</span>
          </div>`;
        }).join("");
      }

      el.innerHTML = html;
    }

    // ============================================
    // RENDER: Sessions
    // ============================================
    function renderSessions(sessions) {
      const tbody = document.getElementById("sessionsTable");
      const empty = document.getElementById("sessionsEmpty");

      if (!sessions || sessions.length === 0) {
        tbody.innerHTML = "";
        empty.style.display = "block";
        return;
      }
      empty.style.display = "none";

      tbody.innerHTML = sessions.map(s => {
        const pnlClass = s.totalPnl >= 0 ? "positive" : "negative";
        return `<tr>
          <td>${shortTime(s.startedAt)}</td>
          <td>${s.endedAt ? shortTime(s.endedAt) : "Active"}</td>
          <td>${s.tradingMode?.toUpperCase()}</td>
          <td>${s.pollsCompleted}</td>
          <td>${s.tradesDetected}</td>
          <td>${s.tradesExecuted}</td>
          <td class="${pnlClass}">$${fmt(s.totalPnl, 2)}</td>
          <td>${s.endingBalance != null ? "$" + fmt(s.endingBalance, 2) : "--"}</td>
        </tr>`;
      }).join("");
    }

    // ============================================
    // TABS
    // ============================================
    document.querySelectorAll(".tab").forEach(tab => {
      tab.addEventListener("click", () => {
        document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
        document.querySelectorAll(".tab-content").forEach(c => c.classList.remove("active"));
        tab.classList.add("active");
        document.getElementById("tab-" + tab.dataset.tab).classList.add("active");
      });
    });

    // ============================================
    // HELPERS
    // ============================================
    function fmt(n, d) {
      if (n == null || isNaN(n)) return "--";
      return Number(n).toFixed(d);
    }

    function setText(id, text) {
      const el = document.getElementById(id);
      if (el) el.textContent = text;
    }

    function colorize(id, value) {
      const el = document.getElementById(id);
      if (!el) return;
      el.className = "card-value " + (value >= 0 ? "positive" : "negative");
    }

    function esc(s) {
      if (!s) return "";
      return s.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;");
    }

    function shortTime(iso) {
      if (!iso) return "--";
      const d = new Date(iso);
      return d.toLocaleDateString(undefined, { month: "short", day: "numeric" }) + " " +
             d.toLocaleTimeString(undefined, { hour: "2-digit", minute: "2-digit", second: "2-digit" });
    }

    function timeAgo(iso) {
      const ms = Date.now() - new Date(iso).getTime();
      const mins = Math.floor(ms / 60000);
      if (mins < 1) return "just now";
      if (mins < 60) return mins + "m ago";
      const hrs = Math.floor(mins / 60);
      if (hrs < 24) return hrs + "h ago";
      return Math.floor(hrs / 24) + "d ago";
    }

    // ============================================
    // INIT
    // ============================================
    connect();
  </script>
</body>
</html>
